<!DOCTYPE html>
<html lang="en">
<head>
  <!-- First paint: dark background + no-flash gate -->
  <style>
    /* Match the app's dark theme color */
    html { background: #0b0b0f; }
    /* Hide body during the head redirect decision to avoid flicker */
    html.boot-hiding body { visibility: hidden; }
  </style>
  <script>
    // Start hidden immediately (before styles/scripts load)
    document.documentElement.classList.add('boot-hiding');
    // Fail-safe: if anything goes wrong, unhide after 1.5s
    setTimeout(function(){
      document.documentElement.classList.remove('boot-hiding');
    }, 1500);
  </script>

  <!-- Mobile UI theming (safe if duplicates are avoided) -->
  <meta name="theme-color" content="#0b0b0f">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Preload main stylesheet so styles are ready ASAP -->
  <!-- If the page already links to styles.css, add this JUST ABOVE that link -->
  <link rel="preload" href="styles.css?v=readability2" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="styles.css?v=readability2"></noscript>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - SHEAR iQ</title>
  <link rel="stylesheet" href="styles.css?v=readability2">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="session-state.js"></script>
  <script type="module" src="auth.js"></script>
  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- PWA icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <!-- Ultra-early launch redirect + no-flash guard -->
  <style>
    /* If a redirect is imminent, prevent any paint */
    html[data-pre-redirect] { visibility: hidden !important; }
  </style>
  <script>
    (function(){
      // Decide as early as possible if we need to redirect, then hide to prevent flash.
      function navIsCold(){
        try {
          var n = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
          return !n || n.type === 'navigate' || n.type === 'reload';
        } catch(e){ return true; }
      }
      function herePage(){
        var p = (location.pathname || '').toLowerCase();
        if (/tally\.html(\?|#|$)/.test(p)) return 'tally';
        if (/dashboard\.html(\?|#|$)/.test(p)) return 'dashboard';
        // Fallback: if unknown, leave blank and do nothing here
        return '';
      }

      var cold = navIsCold();
      var role = (SessionState.get().user_role || '').toLowerCase();
      var pref = (localStorage.getItem('preferred_start') || '').toLowerCase();

      var want = role === 'contractor' ? 'dashboard'
               : role === 'staff'      ? 'tally'
               : (pref || '');

      var here = herePage();

      // >>> NEW: honor explicit user navigation <<<
      var url = new URL(location.href);
      var hasExplicitIntent =
        url.searchParams.has('view') ||
        url.searchParams.has('newDay') ||
        url.searchParams.has('loadedSession') ||
        url.searchParams.get('override') === 'tally';

      // One-time bypass set by buttons before navigating
      var launchOverride = (sessionStorage.getItem('launch_override') || '').toLowerCase();
      if (hasExplicitIntent || launchOverride === 'tally' || launchOverride === 'any') {
        // consume the one-time bypass so it doesn't affect later launches
        sessionStorage.removeItem('launch_override');
      } else if (cold && want && here && want !== here) {
        // Mark pre-redirect to prevent any visual flash
        document.documentElement.setAttribute('data-pre-redirect','1');
        // Redirect immediately before anything renders
        if (want === 'dashboard') location.replace('dashboard.html');
        else if (want === 'tally') location.replace('tally.html');
        return;
      }

      document.addEventListener('DOMContentLoaded', function(){
        document.documentElement.classList.remove('boot-hiding');
      });
    })();
  </script>
</head>
<body>
<!-- DASHBOARD HELP BUTTON -->
<button id="help-btn" aria-haspopup="true" aria-expanded="false" aria-controls="dash-help-menu" title="Help">?</button>

<!-- HELP MENU DROPDOWN -->
<div id="dash-help-menu" role="dialog" aria-modal="false" aria-labelledby="dash-help-title" hidden>
  <div class="dhm-header">
    <h3 id="dash-help-title">Help</h3>
    <button class="dhm-close" id="dhm-close" aria-label="Close help menu">&times;</button>
  </div>
  <div class="dhm-body">
    <label class="dhm-row">
      <input type="checkbox" id="toggle-welcome"> Enable Welcome Popup
    </label>
    <label class="dhm-row">
      <input type="checkbox" id="toggle-tour"> Enable Dashboard Tour
    </label>
    <div class="dhm-actions">
      <button id="btnStartTour" class="dhm-btn">Start Tour</button>
      <button id="btnSkipTour" class="dhm-btn">Skip Tour</button>
      <button id="btnSaveHelp" class="dhm-btn">Save</button>
    </div>
  </div>
</div>
    <div id="page-content" class="dashboard-container" style="display: none;">
      <div class="logo-container">
        <img src="logo.png" alt="SHEΔR iQ logo" />
        <h2 id="dashboard-heading">Contractor Dashboard</h2>
      </div>
      <div class="dashboard-main">
        <p id="dashboard-subheading"></p>
        <!-- BEGIN: Top 5 Shearers Widget -->
        <section id="top5-shearers" class="dash-card top5-widget">
          <header class="dash-card__header">
            <h2 class="dash-card__title">Top 5 Shearers</h2>
            <div class="dash-card__controls">
              <!-- Work type tabs -->
              <div class="siq-segmented" id="worktype-tabs">
                <button type="button" data-worktype="shorn" class="siq-segmented__btn is-active">Shorn</button>
              <button type="button" data-worktype="crutched" class="siq-segmented__btn">Crutched</button>
            </div>
            <!-- View selector -->
            <div class="view-select">
              <label for="shearers-view">View</label>
              <select id="shearers-view">
                <option value="12m" selected>12M Rolling</option>
                <option value="all">All‑Time</option>
              </select>
              <select id="shearers-year" class="year-select" aria-label="Specific year" hidden></select>
            </div>
            <button type="button" id="shearers-viewall" class="siq-link-button">View Full List</button>
          </div>
        </header>

          <div id="top5-shearers-list" class="siq-leaderboard">
            <!-- JS renders 5 rows with bars -->
          </div>
        </section>
        <!-- Full list modal -->
        <div id="shearers-modal" class="siq-modal" aria-hidden="true">
          <div class="siq-modal__backdrop" data-close-modal></div>
          <div class="siq-modal__panel">
            <header class="siq-modal__header">
              <h3>All Shearers — Rankings</h3>
              <button class="siq-modal__close" data-close-modal aria-label="Close">&times;</button>
            </header>
            <div class="siq-modal__body">
              <div class="siq-table-scroll">
                <table class="siq-rank-table" id="shearers-full-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Shearer</th>
                      <th>Total Sheep</th>
                      <th>% of Total</th>
                    </tr>
                  </thead>
                  <tbody><!-- JS fills --></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- END: Top 5 Shearers Widget -->
        <section class="dashboard-buttons">
          <button id="btnManageStaff" class="tab-button">Manage Staff</button>
          <button id="farm-summary-btn" class="dashboard-button">Farm Summary</button>
          <button id="btnViewSavedSessions" class="tab-button">View Saved Sessions</button>
          <button id="btnReturnToActive" class="tab-button" style="display: none;">Return to Active Session</button>
          <button id="btnStartNewDay" class="tab-button">Start New Day</button>
          <button id="btnChangePin" class="tab-button">Change Contractor PIN</button>
          <button id="btnSettings" class="tab-button">Settings / Preferences</button>
          <button id="logoutBtn" class="tab-button">Logout</button>
        </section>
      </div>
    </div>

  <script type="module" src="dashboard.js"></script>
  <div id="loading-overlay">
    <div class="circle-spinner"></div>
    <div>Authenticating… Please wait</div>
  </div>
<!-- DASHBOARD WELCOME MODAL -->
<div id="dashboard-welcome-overlay" aria-hidden="true">
  <div id="dashboard-welcome-modal" role="dialog" aria-modal="true" aria-labelledby="dw-title" aria-describedby="dw-desc">
    <div class="dw-header">
      <h3 id="dw-title">Welcome to the Contractors Dashboard</h3>
      <button class="dw-close" id="dw-close" aria-label="Close welcome modal">&times;</button>
    </div>
    <div class="dw-body" id="dw-desc">
      <p>This dashboard lets you manage your shearing operation quickly and safely. Here’s a quick overview, and you can run a guided tour anytime from the Help button.</p>
      <ul class="dw-list">
        <li><strong>Top 5 Shearers</strong>: See leaders; open “View Full List”.</li>
        <li><strong>Manage Staff</strong>: Add/remove staff; see online/last seen.</li>
        <li><strong>Farm Summary</strong>: Totals and comparisons by farm.</li>
        <li><strong>Saved Sessions</strong>: Reopen past days.</li>
        <li><strong>Return to Active</strong>: Jump back to an unfinished tally (if shown).</li>
        <li><strong>Start New Day</strong>: Begin today’s tally.</li>
        <li><strong>Change Contractor PIN</strong>: Keep control and security tight.</li>
        <li><strong>Settings / Preferences</strong>: Coming soon (not yet enabled).</li>
        <li><strong>Logout</strong>: Safely sign out.</li>
      </ul>
      <div class="dw-row" style="margin-top:10px; display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
        <label class="dw-inline">
          <input type="checkbox" id="dw-enable-welcome">
          Enable Welcome Popup
        </label>
        <label class="dw-inline">
          <input type="checkbox" id="dw-enable-tour">
          Enable Dashboard Tour
        </label>
        <label class="dw-inline">
          <input type="checkbox" id="dw-dont-show">
          Don’t show again
        </label>
      </div>
    </div>
    <div class="dw-footer">
      <button class="dw-btn" id="dw-help">Open Help Menu</button>
      <button class="dw-btn" id="dw-start">Start Tour</button>
      <button class="dw-btn" id="dw-save">Save</button>
      <button class="dw-btn primary" id="dw-ok">Got it</button>
    </div>
  </div>
</div>
  <script src="/pwa-suppress-install.js" defer></script>
  <script src="app-launch-guard.js" defer></script>
  <script>
    try {
      localStorage.setItem('preferred_start', 'dashboard');
    } catch(e) {}
  </script>
</body>
</html>
