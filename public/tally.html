 <!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
   <!-- Configure the viewport so mobile browsers size the page correctly -->
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SHEAR iQ Tally Processor</title>
<link rel="stylesheet" href="styles.css">
   <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="firebase-init.js"></script>
  <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- iOS Home Screen Support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="apple-touch-icon" href="icon-192.png" />

    <!-- Theme Color -->
    <meta name="theme-color" content="#000000" /> 
</head>
<body>


   <div id="tabNav" class="tabs">
  <button class="tab-button active" data-view="tallySheetView">Tally Sheet</button>
  <button class="tab-button" data-view="summaryView">Daily Summary</button>
<button class="tab-button" data-view="stationSummaryView">Station Summary</button>
   </div>
<div id="tallySheetView" class="view">
<div class="logo-container">
      <img src="logo.png" alt="SHEŒîR iQ logo" />
      <h2>Tally Processor</h2>
    </div>
     <button id="newDayResetBtn">New Day Reset</button><br/><br/>
  <label>Date:</label><br/>
<input id="date" type="date"/><br/><br/>
<label>Station Name:</label><br/>
<input id="stationName" class="small-input" type="text"/><br/><br/>
<label>Team Leader:</label><br/>
<input id="teamLeader" class="small-input" type="text"/><br/><br/>
<label>Comb Type:</label><br/>
<input id="combType" class="small-input" type="text">
<div style="margin-top: 14px;">
<div style="display: flex; gap: 14px; margin-bottom: 16px;">
<div style="flex: 1;">
<label for="startTime">Start Time:</label><br/>
<select id="startTime" class="small-input"></select>
</div>
<div style="flex: 1;">
<label for="finishTime">Finish Time:</label><br/>
<select id="finishTime" class="small-input"></select>
</div>
<div style="flex: 1;">
<label for="hoursWorked">Hours Worked:</label><br/>
<input id="hoursWorked" class="small-input" type="text"/>
</div>
</div>
   <button id="timeFormatToggle" class="toggle-button">Switch to 12-hour format</button>
<button id="workdayToggle" class="toggle-button">8 or 9 Hour Day </button>
<div id="timeSystemLabel" class="time-label">Time System: 8-Hour Day</div>
</div>
<h2>Shearers </h2>
<div id="stand-controls" class="button-row">
  <button id="add-stand-btn" onclick="addStand()">Add Stand</button>
  <button id="remove-stand-btn" onclick="removeStand()">Remove Stand</button>
</div>
<div id="count-controls" class="button-row">
  <button id="add-count-btn" onclick="addCount()">Add Count</button>
  <button id="remove-count-btn" onclick="removeCount()">Remove Count</button>
</div>
<table id="tallyTable">
<thead>
<tr id="headerRow">
<th>Count #</th>
  <th>Count Total</th>
  <th class="sheep-type">Sheep Type</th>
</tr>
</thead>
<tbody id="tallyBody">
<!-- Run rows will be added dynamically -->
</tbody>
<tfoot>
<tr id="subtotalRow">
<th>Shearer Totals</th>
</tr>
</tfoot>
</table>
<div class="section">
<h2>Shed Staff</h2>
<div id="shedstaff-controls" class="button-row">
  <button id="add-shedstaff-btn" onclick="addShedStaff()">Add Shed Staff</button>
<button id="remove-shedstaff-btn" onclick="removeShedStaff()">Remove Shed Staff</button>
</div>
   <table>
<thead>
<tr>
<th>Name</th>
<th>Hours Worked</th>
</tr>
    </thead>
    <tbody id="shedStaffTable">
<!-- Shed staff rows will be added dynamically -->
</tbody>
</table>
</div>

<table id="sheepTypeTotalsTable">
  <thead>
    <tr>
      <th>Sheep Type</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<div class="button-row">
    <button id="saveButton" onclick="saveData()">Save</button>
<button id="loadSessionBtn">Load Session</button>
    <button onclick="showExportPrompt()">Export Data</button>
  </div>
   
<div class="button-row" style="justify-content:flex-end;">
    <button id="logoutBtn">Logout</button>
  </div>

<datalist id="sheepTypes">
  <option value="Ram Lambs ">
  <option value="Long Tails">
  <option value="Uncrutched">
  <option value="Fly Blow">
  <option value="Wether Lambs">
  <option value="Ewe Lambs">
  <option value="Mixed Lambs">
  <option value="Merino Lambs">
  <option value="2nd Shear Ewes">
  <option value="Full Wool">
  <option value="Half Bred Ewes">
  <option value="1/4 Bred Ewes">
  <option value="Corridale Ewes">
  <option value="Merino Ewes">
  <option value="Merino Wethers">
  <option value="Rams">
  <option value="Stud Rams">
  <option value="Merino Rams">
  <option value="Merino Stud Rams">
</datalist>

<script src="xlsx.full.min.js"></script>
<script type="module" src="auth.js"></script>
<script type="module" src="tally.js"></script>
<script type="module" src="export.js"></script>
<script type="module" src="serviceworker.js"></script>

  </div> <!-- tallySheetView -->

<div id="summaryView" class="view" style="display:none;">
  <div class="logo-container">
      <img src="logo.png" alt="SHEŒîR iQ logo" />
      <h2>Tally Processor</h2>
  </div>
  <h3 id="summaryTitle" style="margin-top: 10px;"></h3>
  <table id="summaryTable">
    <thead>
      <tr></tr>
    </thead>
    <tbody id="summaryTableBody"></tbody>
  </table>
  <div class="section">
    <h2>Shed Staff</h2>
    <table>
      <thead>
        <tr><th>Name</th><th>Hours Worked</th></tr>
      </thead>
      <tbody id="summaryShedStaff"></tbody>
    </table>
  </div>
</div>

<div id="stationSummaryView" class="view" style="display:none;">
  <div class="logo-container">
      <img src="logo.png" alt="SHEŒîR iQ logo" />
      <h2>Station Summary</h2>
  </div>
  <div class="filters">
    <label for="stationSelect">Station:</label>
     <select id="stationSelect" class="small-input"></select>
    <label for="summaryStart">Start Date:</label>
    <input id="summaryStart" type="date" />
    <label for="summaryEnd">End Date:</label>
    <input id="summaryEnd" type="date" />
    <button id="stationSummaryApply">Apply</button>
  </div>
   <p id="stationNoData" class="message" style="display:none;">No data found for the selected station and dates.</p>
  <h3>Shearer Summary</h3>
  <table id="stationShearerTable">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Shed Staff</h3>
  <table id="stationStaffTable">
    <thead><tr><th>Name</th><th>Hours Worked</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Team Leaders</h3>
  <table id="stationLeaderTable">
    <thead><tr><th>Name</th><th>Total Sheep</th><th>Dates Led</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Comb Types</h3>
  <table id="stationCombTable">
    <thead><tr><th>Comb Type</th><th>Dates Used</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Totals</h3>
  <table id="stationTotalTable">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>
</div>
 
<footer id="footer">Logged in as: <span id="userEmail">loading...</span></footer>
<script>
firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    document.getElementById("userEmail").textContent = user.email;
  } else {
    document.getElementById("userEmail").textContent = "Not logged in";
  }
});
</script>
<!-- Reset Confirmation Modal -->
<div id="resetModal" class="modal-overlay">
  <div class="modal-box">
    <h3>New Day Reset</h3>
    <p>What type of reset do you want to perform?</p>
    <div class="modal-buttons">
      <button id="partialResetBtn">üîÅ Partial Reset</button>
      <button id="fullResetBtn">üóë Full Reset</button>
      <button id="cancelResetBtn">‚ùå Cancel</button>
    </div>
  </div>
</div>

<!-- Load Session Modal -->
<div id="loadSessionModal" class="modal-overlay">
  <div class="modal-box">
    <div id="loadSessionStep1">
      <h3>Load Session</h3>
      <p>Select a session to load:</p>
      <div class="modal-buttons">
        <button id="loadLastBtn">Last Session</button>
        <button id="loadOtherBtn">Other Session</button>
        <button id="cancelLoadBtn">‚ùå Cancel</button>
      </div>
    </div>
    <div id="loadSessionStep2" style="display:none;">
      <label for="loadStationInput">Station:</label><br/>
      <input list="loadStationList" id="loadStationInput" class="small-input"/><br/><br/>
      <label for="loadDateInput">Date (DD/MM/YYYY):</label><br/>
      <input list="loadDateList" id="loadDateInput" class="small-input"/><br/>
      <datalist id="loadStationList"></datalist>
      <datalist id="loadDateList"></datalist>
      <div class="modal-buttons" style="margin-top:10px;">
        <button id="confirmLoadBtn">Load</button>
        <button id="loadSessionBackBtn">Back</button>
      </div>
    </div>
  </div>
</div>
<!-- Unsaved Changes Modal -->
<div id="unsavedModal" class="modal-overlay">
  <div class="modal-box">
    <p>You have unsaved work. What would you like to do?</p>
    <div class="modal-buttons">
      <button id="unsavedSaveBtn">Save & Continue</button>
      <button id="unsavedDiscardBtn">Continue Without Saving</button>
      <button id="unsavedCancelBtn">Cancel</button>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var modal = document.getElementById('resetModal');
  var openBtn = document.getElementById('newDayResetBtn');
  var partialBtn = document.getElementById('partialResetBtn');
  var fullBtn = document.getElementById('fullResetBtn');
  var cancelBtn = document.getElementById('cancelResetBtn');

  function showModal() {
    if (modal) modal.style.display = 'flex';
  }
  function hideModal() {
    if (modal) modal.style.display = 'none';
  }

  function clearCommonFields() {
    document.querySelectorAll('#tallyBody input').forEach(function (el) { el.value = ''; });
    document.querySelectorAll('#tallyBody select').forEach(function (el) { el.value = ''; });
    ['date','startTime','finishTime','hoursWorked'].forEach(function(id){
      var e = document.getElementById(id);
      if (e) e.value = '';
    });
    var totalsBody = document.querySelector('#sheepTypeTotalsTable tbody');
    if (totalsBody) totalsBody.innerHTML = '';
    document.querySelectorAll('#shedStaffTable tr td:nth-child(2) input').forEach(function(el){ el.value = ''; });
  }

  function performReset(full) {
  clearCommonFields();

  if (full) {
    // Clear input fields
    ['stationName','teamLeader','combType'].forEach(function(id){
      const e = document.getElementById(id);
      if (e) e.value = '';
    });

    // ‚úÖ FULL layout clear: remove all rows and columns
    document.getElementById('headerRow').innerHTML = '<th>Count #</th><th>Count Total</th><th class="sheep-type">Sheep Type</th>';
    document.getElementById('tallyBody').innerHTML = '';
    document.getElementById('subtotalRow').innerHTML = '<th>Shearer Totals</th>';
    document.getElementById('shedStaffTable').innerHTML = '';

    // ‚úÖ Reset all counters
    numStands = 0;
    runs = 0;
    layoutBuilt = false;

    window.awaitingSetupPrompt = true;
  }

  const table = document.getElementById('tallyTable');
  if (table) table.dispatchEvent(new Event('input', { bubbles: true }));
  hideModal();
  if (window.unlockSession) window.unlockSession();
}

  window.performReset = performReset;
 
  if (openBtn) openBtn.addEventListener('click', showModal);
  if (partialBtn) partialBtn.addEventListener('click', function(){ performReset(false); });
  if (fullBtn) fullBtn.addEventListener('click', function(){ performReset(true); });
  if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
});
</script>

<script type="module">
import { buildStationSummary, clearStationSummaryView } from './tally.js';
window.clearStationSummaryView = clearStationSummaryView;

document.addEventListener('DOMContentLoaded', () => {
    const applyBtn = document.getElementById('stationSummaryApply');
    if (applyBtn) {
      applyBtn.addEventListener('click', () => {
         alert('‚úÖ Station Summary complete.');
        buildStationSummary();
      });
    }
  });
</script>

</body>
</html>