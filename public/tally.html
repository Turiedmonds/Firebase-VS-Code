 <!DOCTYPE html>

<html lang="en">
  <head>
  <script src="/sw-init.js"></script>
  <script src="boot-router.js"></script>
<!-- First paint: dark background + no-flash gate -->
<style>
  /* Match the app's dark theme color */
  html { background: #0b0b0f; }
  /* Hide body during the head redirect decision to avoid flicker */
  html.boot-hiding body { visibility: hidden; }
</style>
<script>
  // Start hidden immediately (before styles/scripts load)
  document.documentElement.classList.add('boot-hiding');
  // Fail-safe: if anything goes wrong, unhide after 1.5s
  setTimeout(function(){
    document.documentElement.classList.remove('boot-hiding');
  }, 1500);
</script>

<!-- Mobile UI theming (safe if duplicates are avoided) -->
<meta name="theme-color" content="#0b0b0f">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Preload main stylesheet so styles are ready ASAP -->
<!-- If the page already links to styles.css, add this JUST ABOVE that link -->
<link rel="preload" href="styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="styles.css"></noscript>

<meta charset="utf-8"/>
   <!-- Configure the viewport so mobile browsers size the page correctly -->
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SHEAR iQ Tally Processor</title>
<link rel="stylesheet" href="styles.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="firebase-init.js"></script>
  <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- iOS Home Screen Support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" href="icon-192.png" />
  <!-- Tooltip visibility fix -->
  <style id="tt-tooltip-fix">
    #tt-root {
      position: fixed;
      width: calc(100vw - 20px);
      max-width: 280px;
      max-height: calc(100vh - 20px);
      overflow-y: auto;
      pointer-events: none;
      z-index: 900;
    }
    #tt-root.guided {
      pointer-events: auto;
    }
    .tt-hidden {
      display: none;
      opacity: 0;
    }
    .tt-show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
  </style>
  <style id="tt-tooltip-override">
    #tt-root {
      position: fixed;
      width: calc(100vw - 20px);
      max-width: 280px;
      max-height: calc(100vh - 20px);
      overflow-y: auto;
      pointer-events: none;
      z-index: 900;
    }
    #tt-root.guided {
      pointer-events: auto;
    }
    #tt-root.tt-hidden,
    #tt-root[aria-hidden="true"] {
      display: none !important;
      opacity: 0 !important;
    }
    #tt-root.tt-show,
    #tt-root[aria-hidden="false"] {
      display: block !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    }
  </style>
<style id="tally-onboard-styles">
  #tally-onboard-overlay {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.5); z-index: 2147483647;
  }
  #tally-onboard-overlay.show { display: flex; }
  #tally-onboard-dialog {
    background: #111; color: #fff; width: min(520px, 92vw); border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6); padding: 20px;
  }
  #tally-onboard-dialog h2 { margin: 0 0 12px; font-size: 1.3rem; }
  #tally-onboard-dialog p { margin: 0 0 16px; line-height: 1.5; color: #ddd; }
  #tally-onboard-form label { display: block; margin: 8px 0; }
  #tally-onboard-actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end; margin-top: 16px; }

  /* Moved here from old tour styles so buttons keep their look */
  .tw-btn {
    border: 0;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
  }
  .tw-btn-primary { background: #2f81f7; color: #fff; }
  .tw-btn-ghost { background: #222; color: #eee; }
  .tw-btn:focus { outline: 2px solid #5aa0ff; outline-offset: 2px; }
</style>
<style>
  #help-btn, #tour-help-btn {
    touch-action: none;              /* reduce scroll/pan interference */
    -webkit-touch-callout: none;     /* stop iOS text callout */
    -webkit-user-select: none;
    user-select: none;
  }
</style>
<style>
  #setupModal .field-hint{
    display:block;
    margin:4px 0 8px;
    font-size:0.85rem;
    color:#fff;
  }
  #setupModal .form-row > label{
    font-weight:600;
  }
</style>
<!-- Ultra-early launch redirect + no-flash guard -->
<style>
  /* If a redirect is imminent, prevent any paint */
  html[data-pre-redirect] { visibility: hidden !important; }
</style>
<script>
  (function(){
    // Decide as early as possible if we need to redirect, then hide to prevent flash.
    function navIsCold(){
      try {
        var n = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
        return !n || n.type === 'navigate' || n.type === 'reload';
      } catch(e){ return true; }
    }
    function herePage(){
      var p = (location.pathname || '').toLowerCase();
      if (/tally\.html(\?|#|$)/.test(p)) return 'tally';
      if (/dashboard\.html(\?|#|$)/.test(p)) return 'dashboard';
      // Fallback: if unknown, leave blank and do nothing here
      return '';
    }

    var cold = navIsCold();
    var role = (localStorage.getItem('user_role') || '').toLowerCase();
    var pref = (localStorage.getItem('preferred_start') || '').toLowerCase();

    var want = role === 'contractor' ? 'dashboard'
             : role === 'staff'      ? 'tally'
             : (pref || '');

    var here = herePage();

    // >>> NEW: honor explicit user navigation <<<
    var url = new URL(location.href);
    var hasExplicitIntent =
      url.searchParams.has('view') ||
      url.searchParams.has('newDay') ||
      url.searchParams.has('loadedSession') ||
      url.searchParams.get('override') === 'tally';

    // One-time bypass set by buttons before navigating
    var launchOverride = (sessionStorage.getItem('launch_override') || '').toLowerCase();
    var bootRedirected = sessionStorage.getItem('boot_router_redirect') === 'tally';
    if (bootRedirected) sessionStorage.removeItem('boot_router_redirect');
    if (hasExplicitIntent || launchOverride === 'tally' || launchOverride === 'any') {
      // consume the one-time bypass so it doesn't affect later launches
      sessionStorage.removeItem('launch_override');
    } else if (!bootRedirected && cold && want && here && want !== here) {
      // Mark pre-redirect to prevent any visual flash
      document.documentElement.setAttribute('data-pre-redirect','1');
      // Redirect immediately before anything renders
      if (want === 'dashboard') location.replace('dashboard.html');
      else if (want === 'tally') location.replace('tally.html');
      return;
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.documentElement.classList.remove('boot-hiding');
    });
  })();
</script>
</head>
<body>
<script>
  // Safety: if CSS hides the page at boot (e.g. .boot-hiding), unhide after 1200ms no matter what.
  setTimeout(() => { document.documentElement.classList.remove('boot-hiding'); }, 1200);
</script>


   <div id="tabNav" class="tabs">
  <button class="tab-button active" data-view="tallySheetView">Tally Sheet</button>
  <button class="tab-button" data-view="summaryView" data-help="Welcome to the Daily Summary. This section provides you with a concise snapshot of the current day’s tally sheet. It’s designed to offer a straightforward numerical overview: you’ll see exactly how many sheep were shorn, categorized by type, and the total hours worked by shed staff. This summary focuses purely on the day’s output—no dates or team leader details—so you can quickly assess today’s performance at a glance. It's an efficient way to review daily progress before moving on to the next tasks.">Daily Summary</button>
  <button class="tab-button" data-view="stationSummaryView" data-help="Summarize a farm across dates or all time.">Farm Summary</button>
  <button id="back-to-dashboard-btn" class="tab-button" style="display: none;" data-help="Go back to the Contractor Dashboard.">Return to Dashboard</button>
  </div>
<div id="tallySheetView" class="view" data-help="Welcome to the Tally Sheet — the engine room of SHEΔR iQ. This is where you capture all the key data from the shearing day. When you start a new session, a setup prompt appears where you choose how many shearers, how many tally rows per shearer, and how many shed staff are needed. You’ll also select whether the day follows an 8-hour or 9-hour schedule, and set the lunch break duration to match your team.<br/><br/>Each shearer has flexible tally input — not limited to just four runs. Add as many rows as needed to match how your team works. Every row records both the sheep tally and the sheep type. Below the tally table is the Shed Staff section, where you can enter total hours worked for each rousie, presser, or other support crew member.<br/><br/>Start and Finish times are used to automatically calculate hours worked. If someone works through a break (like lunch), simply enter their times and when prompted, confirm that they worked through — the app will add the appropriate time to their hours for you. You can also toggle between 24‑hour and 12‑hour time views depending on your preference.<br/><br/>All fields — including dropdowns like sheep types, team leaders, and comb types — can be typed into manually. Anything you enter will automatically be added to the dropdown list, saving it for future use.<br/><br/>When you tap Save, the system cleans up your data automatically — removing any empty rows or unused fields — so your exports stay tidy and professional. You can export to CSV instantly, or revisit and reload saved sessions at any time.">
<div class="logo-container">
      <img src="logo.png" alt="SHEΔR iQ logo" />
      <h2 id="app-title">Tally Processor</h2>
    </div>
     <button id="newDayResetBtn" class="main-button" data-help="Start a new day. Clears today's entries.">New Day Reset</button><br/><br/>
  <label class="meta-label">Date:</label><br/>
  <input id="date" type="date" data-help="Select the date for this session."/><br/><br/>
  <label for="stationName" class="meta-label">Farm Name:</label><br/>
  <input id="stationName" class="small-input" type="text" data-help="Enter the farm or station name."/><br/><br/>
<label class="meta-label">Team Leader:</label><br/>
  <input id="teamLeader" class="small-input" type="text" data-help="Enter the team leader's name."/><br/><br/>
<label class="meta-label">Comb Type:</label><br/>
  <input id="combType" class="small-input" type="text" list="combTypeOptions" data-help="Enter the comb type used.">
  <datalist id="combTypeOptions">
    <option value="Flat"></option>
    <option value="Cover"></option>
  </datalist>
<div style="margin-top: 14px;">
<div style="display: flex; gap: 14px; margin-bottom: 16px;">
<div style="flex: 1;">
  <label for="startTime" class="meta-label">Start Time:</label><br/>
<select id="startTime" class="small-input" data-help="Choose the start time."></select>
</div>
<div style="flex: 1;">
<label for="finishTime" class="meta-label">Finish Time:</label><br/>
<select id="finishTime" class="small-input" data-help="Choose the finish time."></select>
</div>
<div style="flex: 1;">
<label for="hoursWorked" class="meta-label">Hours Worked:</label><br/>
<input id="hoursWorked" class="small-input" type="text" data-help="Total hours worked. Auto-calculated." data-auto-hours="shearer" placeholder="Auto — set Start &amp; Finish" readonly/>
</div>
</div>
<button id="timeFormatToggle" class="toggle-button" data-help="Switch between 24- and 12-hour times.">Switch to 12-hour format</button>
<button id="workdayToggle" class="toggle-button" data-help="Toggle 8 or 9 hour day.">8 or 9 Hour Day </button>
<button id="lunchToggle" class="toggle-button" data-help="Toggle lunch break length.">Lunch Break</button>
<div id="timeSystemLabel" class="time-label">Time System: 8-Hour Day</div>
<p id="lunchIndicator" class="time-label"></p>
</div>
<h2>Shearers </h2>
<div id="stand-controls" class="button-row">
  <button id="add-stand-btn" data-help="Add a new shearer stand (column)." onclick="addStand()">Add Stand</button>
  <button id="remove-stand-btn" data-help="Remove the last shearer stand." onclick="removeStand()">Remove Stand</button>
</div>
<div id="count-controls" class="button-row">
  <button id="add-count-btn" data-help="Add a new tally run row." onclick="addCount()">Add Count</button>
  <button id="remove-count-btn" data-help="Remove the last tally run." onclick="removeCount()">Remove Count</button>
</div>
<table id="tallyTable">
<thead>
<tr id="headerRow">
<th>Count #</th>
  <th>Count Total</th>
  <th class="sheep-type">Sheep Type</th>
</tr>
</thead>
<tbody id="tallyBody">
<!-- Run rows will be added dynamically -->
</tbody>
<tfoot>
<tr id="subtotalRow">
<th>Shearer Totals</th>
</tr>
</tfoot>
</table>
<div class="section">
<h2>Shed Staff</h2>
<div id="shedstaff-controls" class="button-row">
  <button id="add-shedstaff-btn" data-help="Add a shed staff row." onclick="addShedStaff()">Add Shed Staff</button>
<button id="remove-shedstaff-btn" data-help="Remove the last shed staff row." onclick="removeShedStaff()">Remove Shed Staff</button>
</div>
   <table>
<thead>
<tr>
<th>Name</th>
<th>Hours Worked</th>
</tr>
    </thead>
    <tbody id="shedStaffTable" data-help="Enter staff names and hours.">
<!-- Shed staff rows will be added dynamically -->
</tbody>
</table>
</div>

<table id="sheepTypeTotalsTable" data-help="Totals by sheep type (auto).">
  <thead>
    <tr>
      <th>Sheep Type</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
  <div class="button-row">
    <button id="saveButton" data-help="Save your session (device or cloud)." onclick="saveData(true)">Save</button>
    <button id="loadSessionBtn" data-help="Load a previous session from device or cloud.">Load Session</button>
    <button id="returnTodayBtn" data-help="Bring back today's work if you loaded another session. We keep a backup and this restores it, then clears the backup." onclick="restoreTodaySession()">Return to Today’s Session</button>
    <button id="incidentReportBtn" data-help="Log any accidents or incidents during this session." onclick="showView('incidentView')">Incident Report</button>
    <button id="exportDataBtn" data-help="Export this tally sheet's data to CSV or Excel." onclick="showExportPrompt()">Export Data</button>
  </div>


  <div class="button-row" style="justify-content:flex-end;">
    <button id="logoutBtn">Logout</button>
  </div>

<datalist id="sheepTypes">
 <!-- Adult Females -->
  <option value="2nd Shear Ewes">
  <option value="Full Wool Ewes">
  <option value="Merino Ewes">
  <option value="Half Bred Ewes">
  <option value="1/4 Bred Ewes">
  <option value="Corridale Ewes">
  <option value="Ewes">

  <!-- Lambs – Female -->
  <option value="Ewe Lambs">
  <option value="Merino Ewe Lambs">

  <!-- Lambs – Male -->
  <option value="Ram Lambs">
  <option value="Merino Ram Lambs">

  <!-- Lambs – Wether or Mixed -->
  <option value="Wether Lambs">
  <option value="Mixed Lambs">
  <option value="Long Tails">

  <!-- Adult Males -->
  <option value="Rams">
  <option value="Stud Rams">
  <option value="Merino Rams">
  <option value="Merino Stud Rams">
  <option value="Wethers">
  <option value="Merino Wethers">

  <!-- Unknown / Crutching -->
  <option value="Uncrutched">
  <option value="Fly Blow">
  <option value="Full Belly Crutching">
  <option value="Ring Crutching">
</datalist>

<script src="xlsx.full.min.js"></script>
<script type="module" src="auth.js"></script>
<script src="/export.js"></script>
<script src="/tally.js?v=help-in-tour-2"></script>
  </div> <!-- tallySheetView -->

<div id="summaryView" class="view" style="display:none;">
  <div class="logo-container">
      <img src="logo.png" alt="SHEΔR iQ logo" />
      <h2>Daily Summary</h2>
  </div>
  <h3 id="summaryTitle" style="margin-top: 10px;"></h3>
  <table id="summaryTable" data-help="Totals per shearer for this day.">
    <thead>
      <tr></tr>
    </thead>
    <tbody id="summaryTableBody"></tbody>
  </table>
  <div class="section">
    <h2>Shed Staff</h2>
    <table>
      <thead>
        <tr><th>Name</th><th>Hours Worked</th></tr>
      </thead>
      <tbody id="summaryShedStaff" data-help="Hours worked by shed staff for this day."></tbody>
    </table>
  </div>
</div>

<div id="stationSummaryView" class="view" style="display:none;">
  <div id="farmSummarySection" data-help="
    <strong>Farm Summary — Your One-Stop Payroll Hub</strong><br><br>
    <strong>Welcome to your Farm Summary!</strong><br><br>
    This is your central hub for payroll. It pulls together everything in one place so you can see exactly who worked, where, and how many — all with just a few clicks. Here's how it works from top to bottom:<br><br>

    <strong>🔍 Filters at the Top:</strong> Quickly narrow your view by selecting a farm, date range, or sheep type. Use the <em>Quick Range</em> selector to instantly load data for the past 7, 14, or 30 days — perfect for payroll or end-of-week checks.<br><br>

    <strong>👥 Shearers Summary:</strong> Clearly shows which shearers worked on each farm, what types of sheep, and how many sheep they have shorn. It also breaks down totals by sheep type (e.g., lambs, full wool) — helping you confirm pay rates and assess team performance at a glance.<br><br>

    <strong>🧰 Shed Staff Summary:</strong> Just like shearers, this section tracks shed hands, pressers, and other support crew across each farm. It helps make sure their hours and roles are properly recorded for fair pay.<br><br>

    <strong>🎖️ Team Leaders:</strong> Displays who was leading the team on each day — useful when calculating team leader rates.<br><br>

    <strong>🔩 Comb Types:</strong> Lists which combs were used across each farm session. That matters because different combs can affect shearing rates and pay agreements.<br><br>

    <strong>📊 Totals Section:</strong> Gives you clear totals for each sheep type for each farm in the selected date range. Helpful for invoicing.<br><br>

    <strong>📁 Export Button:</strong> Once you’ve reviewed everything, hit Export to download a CSV — perfect for copying straight into your payroll system or sending with an invoice if your payroll system allows.<br><br>

    <em>This page is built to save you time.</em> No more digging through tally books, time sheets or photos trying to match up data — it's all here in one spot, ready when you need it.
  ">
  <div class="logo-container">
      <img src="logo.png" alt="SHEΔR iQ logo" />
      <h2>Farm Summary</h2>
  </div>
  <div class="filters">
  <label for="stationSelect">Farm:</label>
  <select id="stationSelect" class="small-input" data-help="Choose a farm to summarize."></select>

  <label for="summaryStart">Start Date:</label>
  <input id="summaryStart" type="date" data-help="Start date for the farm summary." />

  <label for="summaryEnd">End Date:</label>
  <input id="summaryEnd" type="date" data-help="End date for the farm summary." />

  <label style="display:inline-flex;align-items:center;gap:6px;margin-left:10px;" data-help="Include all records for this farm.">
    <input type="checkbox" id="summaryAllTime" />
    All time for this farm
  </label>

  <span style="display:inline-flex;align-items:center;gap:6px;margin-left:10px;">
    <label for="lastNDaysInput">Days Back:</label>
    <input id="lastNDaysInput" class="small-input" type="number" min="1" value="7" placeholder="e.g. 7 = last 7 days" style="width:60px;" data-help="Days back for the preset (e.g., 7 = last 7 days)." />
    <button id="summaryApplyLastN" type="button" title="Quickly set Start/End to the last N days" data-help="Use Quick Range to instantly fill Start and End dates with the last N days. Adjust the number as needed, then click this button.">Quick Range</button>
  </span>

  <button id="stationSummaryApply" data-help="Apply the selected filters.">Apply</button>
  <button id="stationSummaryReset" type="button" data-help="Clear the filters.">Reset</button>
</div>

<p id="stationNoData" class="message" style="margin-top:8px;">
  Select a farm and date range, or tick “All time for this farm”, then press Apply.
</p>
  <h2 id="farmDataTitle"></h2>
  <h3>Shearer Summary</h3>
  <table id="stationShearerTable" data-help="Totals per shearer for the selected period.">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Shed Staff</h3>
  <table id="stationStaffTable" data-help="Hours worked by shed staff in this period.">
    <thead><tr><th>Name</th><th>Hours Worked</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Team Leaders</h3>
  <table id="stationLeaderTable" data-help="Tallies for each team leader.">
    <thead><tr><th>Name</th><th>Total Sheep</th><th>Dates Led</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Comb Types</h3>
  <table id="stationCombTable" data-help="Comb types used during the period.">
    <thead><tr><th>Comb Type</th><th>Dates Used</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Sheep Type Totals</h3>
  <table id="stationTotalTable" data-help="Overall totals for the farm.">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>
  <button id="exportFarmSummaryBtn" class="main-button" data-help="Export the farm summary.">Export Farm Summary</button>
  </div>
</div>

<div id="incidentView" class="view" style="display:none;">
  <div class="logo-container">
      <img src="logo.png" alt="SHEΔR iQ logo" />
      <h2>Incident Report</h2>
  </div>
  <div class="section">
    <table id="incidentTable" data-help="Record any incidents or accidents during this session.">
      <thead><tr><th>Time</th><th>Name</th><th>Description</th></tr></thead>
      <tbody id="incidentBody">
        <tr>
          <td data-label="Time"><input type="time" /></td>
          <td data-label="Name"><input type="text" placeholder="Name" /></td>
          <td data-label="Description"><textarea placeholder="Describe incident..."></textarea></td>
        </tr>
      </tbody>
    </table>
      <button id="addIncidentBtn" onclick="addIncident()">Add Incident</button>
      <button id="removeIncidentBtn" onclick="removeIncident()">Remove Incident</button>
      <button onclick="showView('tallySheetView')">Back to Tally Sheet</button>
    </div>
  </div>

<footer id="footer">Logged in as: <span id="userEmail">loading...</span></footer>

<!-- Setup Modal -->
<div id="setupModal" class="modal-overlay">
  <div class="modal-box">
    <h3>Setup Day</h3>
    <div class="form-row">
      <label for="setupShearers"># Shearers</label>
      <small class="field-hint">Number of shearers today (Adds columns to the shearer table).</small>
      <select id="setupShearers"></select>
    </div>

    <div class="form-row">
      <label for="setupRuns"># Tally Rows</label>
      <small class="field-hint">How many runs or cut outs today? (Adds rows to the shearer table)</small>
      <select id="setupRuns"></select>
    </div>

    <div class="form-row">
      <label for="setupStaff"># Shed Staff</label>
      <small class="field-hint">Number of shed staff today? (Adds rows to the shed staff table)</small>
      <select id="setupStaff"></select>
    </div>

    <div class="form-row">
      <label for="lunchLength">Lunch Break Length</label>
      <small class="field-hint">How long is lunch break. 45 minutes or 1 hour</small>
      <select id="lunchLength">
        <option value="60">60 minutes</option>
        <option value="45">45 minutes</option>
      </select>
    </div>

    <div class="form-row" style="margin-top:12px">
      <label>
        <input type="checkbox" id="disableSetupModalFromSetup">
        Don’t show this Setup Day popup automatically
      </label>
      <small class="field-hint">You can turn this back on anytime from the Help menu.</small>
    </div>

    <div class="modal-buttons" style="margin-top:20px;">
      <button id="setupConfirmBtn">Confirm</button>
      <button id="setupCancelBtn">Cancel</button>
    </div>
  </div>
</div>
<script>
firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    document.getElementById("userEmail").textContent = user.email;
  } else {
    document.getElementById("userEmail").textContent = "Not logged in";
  }
});

document.addEventListener('DOMContentLoaded', function () {
  ['setupShearers', 'setupRuns', 'setupStaff'].forEach(function(id) {
    var select = document.getElementById(id);
    if (!select) return;
    var opts = '<option value=""></option>';
    for (var i = 1; i <= 100; i++) {
      opts += '<option value="' + i + '">' + i + '</option>';
    }
    select.innerHTML = opts;
  });
});
</script>
<!-- Reset Confirmation Modal -->
<div id="resetModal" class="modal-overlay">
  <div class="modal-box">
    <h3>New Day Reset</h3>
    <p>What type of reset do you want to perform?</p>
    <div class="modal-buttons">
      <button id="partialResetBtn">🔁 Partial Reset</button>
      <button id="fullResetBtn">🗑 Full Reset</button>
      <button id="cancelResetBtn">❌ Cancel</button>
    </div>
  </div>
</div>

<!-- Load Session Modal -->
<div id="loadSessionModal" class="modal-overlay">
  <div class="modal-box">
    <div id="loadSessionStep1">
      <h3>Load Session</h3>
      <p>Select a session to load:</p>
      <div class="modal-buttons">
        <button id="loadLastBtn">Last Session</button>
        <button id="loadOtherBtn">Other Session</button>
        <button id="cancelLoadBtn">❌ Cancel</button>
      </div>
    </div>
    <div id="loadSessionStep2" style="display:none;">
      <label for="loadStationInput">Station:</label><br/>
      <input list="loadStationList" id="loadStationInput" class="small-input"/><br/><br/>
      <label for="loadDateInput">Date (DD/MM/YYYY):</label><br/>
      <input list="loadDateList" id="loadDateInput" class="small-input"/><br/>
      <datalist id="loadStationList"></datalist>
      <datalist id="loadDateList"></datalist>
      <div class="modal-buttons" style="margin-top:10px;">
        <button id="confirmLoadBtn">Load</button>
        <button id="loadSessionBackBtn">Back</button>
      </div>
    </div>
  </div>
</div>
<!-- Unsaved Changes Modal -->
  <div id="unsavedModal" class="modal-overlay">
    <div class="modal-box">
      <p>You have unsaved work. What would you like to do?</p>
      <div class="modal-buttons">
        <button id="unsavedSaveBtn">Save & Continue</button>
        <button id="unsavedDiscardBtn">Continue Without Saving</button>
        <button id="unsavedCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

<!-- Load Session Confirmation Modal -->
<div id="loadSessionConfirmModal" class="modal-overlay">
  <div class="modal-box">
    <p id="loadSessionConfirmMessage" style="white-space: pre-line;"></p>
    <div class="modal-buttons">
      <button id="loadSessionConfirmYes">Load</button>
      <button id="loadSessionConfirmNo">Cancel</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var modal = document.getElementById('resetModal');
  var openBtn = document.getElementById('newDayResetBtn');
  var partialBtn = document.getElementById('partialResetBtn');
  var fullBtn = document.getElementById('fullResetBtn');
  var cancelBtn = document.getElementById('cancelResetBtn');

  function showModal() {
    if (modal) modal.style.display = 'flex';
  }
  function hideModal() {
    if (modal) modal.style.display = 'none';
  }

  function clearCommonFields() {
    document.querySelectorAll('#tallyBody input').forEach(function (el) { el.value = ''; });
    document.querySelectorAll('#tallyBody select').forEach(function (el) { el.value = ''; });
    ['date','startTime','finishTime','hoursWorked'].forEach(function(id){
      var e = document.getElementById(id);
      if (e) e.value = '';
    });
    var totalsBody = document.querySelector('#sheepTypeTotalsTable tbody');
    if (totalsBody) totalsBody.innerHTML = '';
    document.querySelectorAll('#shedStaffTable tr td:nth-child(2) input').forEach(function(el){ el.value = ''; });
    var incidentBody = document.getElementById('incidentBody');
    if (incidentBody) {
      incidentBody.innerHTML = '<tr><td><input type="time" /></td><td><input type="text" placeholder="Name" /></td><td><textarea placeholder="Describe incident..."></textarea></td></tr>';
    }
  }

  function performReset(full) {
  if (!full) allowCleanup = false;
  clearCommonFields();
  // Always clear cached session metadata so a new day doesn't reuse the old ID
  if (window.resetForNewDay) window.resetForNewDay();

  if (full) {
    // Clear input fields
    ['stationName','teamLeader','combType'].forEach(function(id){
      const e = document.getElementById(id);
      if (e) e.value = '';
    });

    if (window.resetTallySheet) window.resetTallySheet(); 
    window.awaitingSetupPrompt = true;
  }

  const table = document.getElementById('tallyTable');
  if (table) table.dispatchEvent(new Event('input', { bubbles: true }));
  if (typeof autosaveTimer !== 'undefined') {
    clearTimeout(autosaveTimer);
    autosaveTimer = null;
  }
  localStorage.removeItem('active_session');
  hideModal();
  if (window.unlockSession) window.unlockSession();
}

  window.performReset = performReset;
 
  if (openBtn) openBtn.addEventListener('click', showModal);
  if (partialBtn) partialBtn.addEventListener('click', function(){ performReset(false); });
  if (fullBtn) fullBtn.addEventListener('click', function(){ performReset(true); });
  if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
});
</script>

<!-- Load Options Modal -->
<div id="loadOptionsModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Where do you want to load from?</h3>
    <div class="modal-buttons">
      <button id="loadLocalBtn">📁 Load from Device</button>
      <button id="loadCloudBtn">☁️ Load from Cloud</button>
    </div>
  </div>
</div>

<!-- Save Options Modal -->
<div id="saveOptionsModal" class="modal-overlay">
  <div class="modal-box">
    <h3>Save Session</h3>
    <div class="modal-buttons">
      <button id="saveLocalBtn">📁 Save to Device</button>
      <button id="saveCloudBtn">☁️ Save to Cloud</button>
      <button id="saveBothBtn">🔄 Save to Both</button>
    </div>
  </div>
</div>

<!-- Cloud Session Modal -->
<div id="cloudSessionModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Select Cloud Session</h3>
    <select id="cloudSessionSelect" class="small-input" style="width:100%; margin-bottom:10px;"></select>
    <div class="modal-buttons">
      <button id="loadCloudConfirmBtn">Load Selected Session</button>
      <button id="cancelCloudLoadBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Date List Modal -->
<div id="dateListModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>All Dates</h3>
    <div id="dateListContent" style="max-height:200px; overflow-y:auto; text-align:left;"></div>
    <div class="modal-buttons" style="margin-top:10px;">
      <button id="dateListCloseBtn">Close</button>
    </div>
  </div>
</div>

<div id="autosaveStatus" style="display:none; position:fixed; bottom:10px; right:10px; background:#222; color:#fff; padding:4px 8px; border-radius:4px; font-size:14px;"></div>
<div id="hours-modal" class="hours-modal" aria-hidden="true">
  <div class="hours-modal-content">
    <p>Hours Worked automatically fills from Start and Finish times.</p>
    <div class="hours-modal-actions">
      <button type="button" id="hours-modal-ok">OK</button>
      <button type="button" id="hours-modal-manual">Enable manual entry</button>
    </div>
  </div>
</div>
<div id="autosaveInfo" style="display:none; position:fixed; bottom:10px; left:10px; color:#888; font-size:12px;"></div>
<div id="loading-overlay">
  <div class="circle-spinner"></div>
  <div>Authenticating… Please wait</div>
</div>

<button id="help-btn" aria-label="Help">?</button>
<div id="tt-help-menu" class="tt-hidden" aria-hidden="true"></div>
<div id="tt-root" class="tt-hidden" role="tooltip" aria-hidden="true" aria-live="polite"></div>



<style>
    #tt-root {
      position: fixed;
      width: calc(100vw - 20px);
      max-width: 280px;
      max-height: calc(100vh - 20px);
      overflow-y: auto;
      padding: 10px 12px;
      background: rgba(20,20,20,0.95);
      color: #fff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      z-index: 900;
      font-size: 14px;
      line-height: 1.35;
      pointer-events: none;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 120ms ease, transform 120ms ease;
    }
    #tt-root.guided {
      pointer-events: auto;
    }
    #tt-root .tt-guided-controls {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    .tt-highlight {
      outline: 3px solid rgba(255,255,255,0.5);
      outline-offset: 3px;
      border-radius: 8px;
    }
    .tt-show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    .tt-hidden {
      display: none;
      opacity: 0;
    }
    @media (prefers-reduced-motion: reduce) {
      #tt-root { transition: none; }
    }
    #tt-disabled-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20,20,20,0.95);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 9999;
      display: none;
    }
    #setup-reminder-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20,20,20,0.95);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 9999;
      display: none;
      cursor: pointer;
    }
  </style>

<style id="tt-help-menu-base">
  #tt-help-menu{
    position:fixed;
    z-index:2147483646;
    display:none;
    background:rgba(20,20,20,0.97);
    color:#fff;
    padding:12px;
    border-radius:10px;
    min-width:240px;
    max-width:calc(100vw - 16px);
    max-height:80vh;
    overflow:auto;
    box-shadow:0 10px 30px rgba(0,0,0,.45);
  }
  #tt-help-menu .row{display:flex;gap:8px;margin-top:10px}
  #tt-help-menu button,#tt-help-menu label{font-size:14px;line-height:1.2}
</style>

<!-- Tally Onboarding Modal (Merged) -->
<div id="tally-onboard-overlay" role="dialog" aria-modal="true" aria-labelledby="tally-onboard-title" aria-hidden="true">
  <div id="tally-onboard-dialog">
    <h2 id="tally-onboard-title">Welcome to the SHEΔR iQ Tally Tour</h2>
    <p>This quick tour will show you the key parts of the tally page and how to use them. You can skip it anytime and revisit the guided tour later from the Help menu.</p>
    <p>You can enable or disable the guided tour anytime from the Help menu (the “?” button).</p>
    <p>The Help menu also lets you choose an Autosave mode: Off, Local, Cloud or Both.</p>

    <form id="tally-onboard-form">
      <label><input type="checkbox" id="onboard-tour"> Enable guided tour</label>
      <label><input type="checkbox" id="onboard-hide"> Don't show again</label>
    </form>

    <div id="tally-onboard-actions">
      <button type="button" id="onboard-save-start" class="tw-btn tw-btn-primary">Save &amp; Start Tour</button>
      <button type="button" id="onboard-save" class="tw-btn tw-btn-ghost">Save Only</button>
      <button type="button" id="onboard-help" class="tw-btn tw-btn-ghost">Open Help Menu</button>
      <button type="button" id="onboard-skip" class="tw-btn tw-btn-ghost">Skip for now</button>
    </div>
  </div>
  <span aria-hidden="true"></span>
</div>
<script>
(function(){
  const overlay = document.getElementById('tally-onboard-overlay');
  const tour = document.getElementById('onboard-tour');
  const saveStart = document.getElementById('onboard-save-start');
  const saveOnly = document.getElementById('onboard-save');
  const openHelp = document.getElementById('onboard-help');
  const skip = document.getElementById('onboard-skip');
  const dontShow = document.getElementById('onboard-hide');

  const gb = k => (localStorage.getItem(k) ?? 'true') === 'true';

  function openModal(){
    if (localStorage.getItem('tally_onboard_seen') === 'true') return;
    tour.checked = gb('tally_guide_enabled');
    dontShow.checked = false;
    overlay.classList.add('show');
    overlay.removeAttribute('aria-hidden');
    document.body.style.overflow = 'hidden';
    const first = overlay.querySelector('input,button');
    if (first) first.focus();
  }

  function closeModal(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  function saveChoices(){
    // persist to storage
    localStorage.setItem('tally_guide_enabled', tour.checked ? 'true' : 'false');

    // NEW: update runtime flag immediately (safe if function doesn’t exist)
    try { if (typeof window.setGuideEnabled === 'function') window.setGuideEnabled(!!tour.checked); } catch(e){}

    // mark onboarding as seen only if user opts out
    if (dontShow.checked) localStorage.setItem('tally_onboard_seen','true');
    else localStorage.removeItem('tally_onboard_seen');
  }

  saveStart.addEventListener('click', () => {
    saveChoices();
    closeModal();
    if (tour.checked && typeof window.startGuide === 'function') window.startGuide();
  });
  saveOnly.addEventListener('click', () => { saveChoices(); closeModal(); });
  openHelp.addEventListener('click', () => { saveChoices(); closeModal(); if (typeof window.openHelpMenu === 'function') window.openHelpMenu(); });
  skip.addEventListener('click', () => {
    if (dontShow.checked) localStorage.setItem('tally_onboard_seen','true');
    else localStorage.removeItem('tally_onboard_seen');
    closeModal();
  });

  overlay.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { e.preventDefault(); skip.click(); }
    if (e.key === 'Tab') {
      const focusables = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (focusables.length === 0) return;
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
  });

  document.addEventListener('DOMContentLoaded', openModal);
})();
</script>
<div id="logoutModal" class="modal-overlay">
  <div class="modal-box">
    <p>Warning: You won’t be able to log back in without internet access. Are you sure you want to log out?</p>
    <div class="modal-buttons">
      <button id="logoutConfirmBtn">Yes, Log Out</button>
      <button id="logoutCancelBtn">Cancel</button>
    </div>
  </div>
</div>
<div id="syncStatusBanner"></div>
  <script src="/pwa-suppress-install.js" defer></script>
  <script src="app-launch-guard.js" defer></script>
  <script>
    try {
      if (!localStorage.getItem('user_role')) {
        localStorage.setItem('user_role', 'staff');
      }
      localStorage.setItem('preferred_start', 'tally');
    } catch(e) {}
  </script>
  <script>
    (function(){
      const role = (localStorage.getItem('user_role') || '').toLowerCase();
      if (role === 'contractor' && !navigator.onLine) {
        console.log('[offline-nav] Serving cached dashboard/tally pages');
        const toast = document.createElement('div');
        toast.textContent = 'Offline mode: cached pages active';
        Object.assign(toast.style, {
          position: 'fixed', bottom: '10px', left: '50%', transform: 'translateX(-50%)',
          background: 'rgba(0,0,0,0.7)', color: '#fff', padding: '8px 12px',
          borderRadius: '4px', zIndex: 1000
        });
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    })();
  </script>
</body>
</html>
