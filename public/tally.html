 <!DOCTYPE html>

<html lang="en">
<head>
<!-- First paint: dark background + no-flash gate -->
<style>
  /* Match the app's dark theme color */
  html { background: #0b0b0f; }
  /* Hide body during the head redirect decision to avoid flicker */
  html.boot-hiding body { visibility: hidden; }
</style>
<script>
  // Start hidden immediately (before styles/scripts load)
  document.documentElement.classList.add('boot-hiding');
  // Fail-safe: if anything goes wrong, unhide after 1.5s
  setTimeout(function(){
    document.documentElement.classList.remove('boot-hiding');
  }, 1500);
</script>

<!-- Mobile UI theming (safe if duplicates are avoided) -->
<meta name="theme-color" content="#0b0b0f">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Preload main stylesheet so styles are ready ASAP -->
<!-- If the page already links to styles.css, add this JUST ABOVE that link -->
<link rel="preload" href="styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="styles.css"></noscript>

<meta charset="utf-8"/>
   <!-- Configure the viewport so mobile browsers size the page correctly -->
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SHEAR iQ Tally Processor</title>
<link rel="stylesheet" href="styles.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="firebase-init.js"></script>
  <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- iOS Home Screen Support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" href="icon-192.png" />
  <!-- Tooltip visibility fix -->
  <style id="tt-tooltip-fix">
    #tt-root {
      position: fixed;
      max-width: 280px;
      pointer-events: none;
      z-index: 900;
    }
    #tt-root.guided {
      pointer-events: auto;
    }
    .tt-hidden {
      display: none;
      opacity: 0;
    }
    .tt-show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
  </style>
  <style id="tt-tooltip-override">
    #tt-root {
      position: fixed;
      max-width: 280px;
      pointer-events: none;
      z-index: 900;
    }
    #tt-root.guided {
      pointer-events: auto;
    }
    #tt-root.tt-hidden,
    #tt-root[aria-hidden="true"] {
      display: none !important;
      opacity: 0 !important;
    }
    #tt-root.tt-show,
    #tt-root[aria-hidden="false"] {
      display: block !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    }
  </style>
<style id="tally-onboard-styles">
  #tally-onboard-overlay {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.5); z-index: 2147483647;
  }
  #tally-onboard-overlay.show { display: flex; }
  #tally-onboard-dialog {
    background: #111; color: #fff; width: min(520px, 92vw); border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6); padding: 20px;
  }
  #tally-onboard-dialog h2 { margin: 0 0 12px; font-size: 1.3rem; }
  #tally-onboard-dialog p { margin: 0 0 16px; line-height: 1.5; color: #ddd; }
  #tally-onboard-form label { display: block; margin: 8px 0; }
  #tally-onboard-actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end; margin-top: 16px; }

  /* Moved here from old tour styles so buttons keep their look */
  .tw-btn {
    border: 0;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
  }
  .tw-btn-primary { background: #2f81f7; color: #fff; }
  .tw-btn-ghost { background: #222; color: #eee; }
  .tw-btn:focus { outline: 2px solid #5aa0ff; outline-offset: 2px; }
</style>
<style>
  #help-btn, #tour-help-btn {
    touch-action: none;              /* reduce scroll/pan interference */
    -webkit-touch-callout: none;     /* stop iOS text callout */
    -webkit-user-select: none;
    user-select: none;
  }
</style>
<style>
  .field-hint{
    display:block;
    margin:4px 0 8px;
    font-size:0.9rem;
    opacity:0.8;
  }
</style>
<!-- Ultra-early launch redirect + no-flash guard -->
<style>
  /* If a redirect is imminent, prevent any paint */
  html[data-pre-redirect] { visibility: hidden !important; }
</style>
<script>
  (function(){
    // Decide as early as possible if we need to redirect, then hide to prevent flash.
    function navIsCold(){
      try {
        var n = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
        return !n || n.type === 'navigate' || n.type === 'reload';
      } catch(e){ return true; }
    }
    function herePage(){
      var p = (location.pathname || '').toLowerCase();
      if (/tally\.html(\?|#|$)/.test(p)) return 'tally';
      if (/dashboard\.html(\?|#|$)/.test(p)) return 'dashboard';
      // Fallback: if unknown, leave blank and do nothing here
      return '';
    }

    var cold = navIsCold();
    var role = (localStorage.getItem('user_role') || '').toLowerCase();
    var pref = (localStorage.getItem('preferred_start') || '').toLowerCase();

    var want = role === 'contractor' ? 'dashboard'
             : role === 'staff'      ? 'tally'
             : (pref || '');

    var here = herePage();

    // >>> NEW: honor explicit user navigation <<<
    var url = new URL(location.href);
    var hasExplicitIntent =
      url.searchParams.has('view') ||
      url.searchParams.has('newDay') ||
      url.searchParams.has('loadedSession') ||
      url.searchParams.get('override') === 'tally';

    // One-time bypass set by buttons before navigating
    var launchOverride = (sessionStorage.getItem('launch_override') || '').toLowerCase();
    if (hasExplicitIntent || launchOverride === 'tally' || launchOverride === 'any') {
      // consume the one-time bypass so it doesn't affect later launches
      sessionStorage.removeItem('launch_override');
    } else if (cold && want && here && want !== here) {
      // Mark pre-redirect to prevent any visual flash
      document.documentElement.setAttribute('data-pre-redirect','1');
      // Redirect immediately before anything renders
      if (want === 'dashboard') location.replace('dashboard.html');
      else if (want === 'tally') location.replace('tally.html');
      return;
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.documentElement.classList.remove('boot-hiding');
    });
  })();
</script>
</head>
<body>


   <div id="tabNav" class="tabs">
  <button class="tab-button active" data-view="tallySheetView">Tally Sheet</button>
  <button class="tab-button" data-view="summaryView">Daily Summary</button>
  <button class="tab-button" data-view="stationSummaryView">Farm Summary</button>
  <button id="back-to-dashboard-btn" class="tab-button" style="display: none;" data-help="Go back to the Contractor Dashboard.">Return to Dashboard</button>
  </div>
<div id="tallySheetView" class="view">
<div class="logo-container">
      <img src="logo.png" alt="SHEŒîR iQ logo" />
      <h2 id="app-title">Tally Processor</h2>
    </div>
     <button id="newDayResetBtn" class="main-button" data-help="Start a new day. Clears today's entries.">New Day Reset</button><br/><br/>
  <label class="meta-label">Date:</label><br/>
  <input id="date" type="date" data-help="Select the date for this session."/><br/><br/>
  <label for="stationName" class="meta-label">Farm Name:</label><br/>
  <input id="stationName" class="small-input" type="text" data-help="Enter the farm or station name."/><br/><br/>
<label class="meta-label">Team Leader:</label><br/>
  <input id="teamLeader" class="small-input" type="text" data-help="Enter the team leader's name."/><br/><br/>
<label class="meta-label">Comb Type:</label><br/>
  <input id="combType" class="small-input" type="text" data-help="Enter the comb type used.">
<div style="margin-top: 14px;">
<div style="display: flex; gap: 14px; margin-bottom: 16px;">
<div style="flex: 1;">
  <label for="startTime" class="meta-label">Start Time:</label><br/>
<select id="startTime" class="small-input" data-help="Choose the start time."></select>
</div>
<div style="flex: 1;">
<label for="finishTime" class="meta-label">Finish Time:</label><br/>
<select id="finishTime" class="small-input" data-help="Choose the finish time."></select>
</div>
<div style="flex: 1;">
<label for="hoursWorked" class="meta-label">Hours Worked:</label><br/>
<input id="hoursWorked" class="small-input" type="text" data-help="Total hours worked. Auto-calculated." data-auto-hours="shearer" placeholder="Auto ‚Äî set Start &amp; Finish" readonly/>
</div>
</div>
<button id="timeFormatToggle" class="toggle-button" data-help="Switch between 24- and 12-hour times.">Switch to 12-hour format</button>
<button id="workdayToggle" class="toggle-button" data-help="Toggle 8 or 9 hour day.">8 or 9 Hour Day </button>
<button id="lunchToggle" class="toggle-button" data-help="Toggle lunch break length.">Lunch Break</button>
<div id="timeSystemLabel" class="time-label">Time System: 8-Hour Day</div>
<p id="lunchIndicator" class="time-label"></p>
</div>
<h2>Shearers </h2>
<div id="stand-controls" class="button-row">
  <button id="add-stand-btn" data-help="Add a new shearer stand (column)." onclick="addStand()">Add Stand</button>
  <button id="remove-stand-btn" data-help="Remove the last shearer stand." onclick="removeStand()">Remove Stand</button>
</div>
<div id="count-controls" class="button-row">
  <button id="add-count-btn" data-help="Add a new tally run row." onclick="addCount()">Add Count</button>
  <button id="remove-count-btn" data-help="Remove the last tally run." onclick="removeCount()">Remove Count</button>
</div>
<table id="tallyTable" data-help="Enter tallies by run and stand. Add sheep type for each run.">
<thead>
<tr id="headerRow">
<th>Count #</th>
  <th>Count Total</th>
  <th class="sheep-type">Sheep Type</th>
</tr>
</thead>
<tbody id="tallyBody">
<!-- Run rows will be added dynamically -->
</tbody>
<tfoot>
<tr id="subtotalRow">
<th>Shearer Totals</th>
</tr>
</tfoot>
</table>
<div class="section">
<h2>Shed Staff</h2>
<div id="shedstaff-controls" class="button-row">
  <button id="add-shedstaff-btn" data-help="Add a shed staff row." onclick="addShedStaff()">Add Shed Staff</button>
<button id="remove-shedstaff-btn" data-help="Remove the last shed staff row." onclick="removeShedStaff()">Remove Shed Staff</button>
</div>
   <table>
<thead>
<tr>
<th>Name</th>
<th>Hours Worked</th>
</tr>
    </thead>
    <tbody id="shedStaffTable" data-help="Enter staff names and hours.">
<!-- Shed staff rows will be added dynamically -->
</tbody>
</table>
</div>

<table id="sheepTypeTotalsTable" data-help="Totals by sheep type (auto).">
  <thead>
    <tr>
      <th>Sheep Type</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
  <div class="button-row">
    <button id="saveButton" data-help="Save your session (device or cloud)." onclick="saveData(true)">Save</button>
    <button id="loadSessionBtn" data-help="Load a previous session from device or cloud.">Load Session</button>
    <button onclick="restoreTodaySession()">Return to Today‚Äôs Session</button>
    <button onclick="showExportPrompt()">Export Data</button>
  </div>


  <div class="button-row" style="justify-content:flex-end;">
    <button id="logoutBtn">Logout</button>
  </div>

<datalist id="sheepTypes">
 <!-- Adult Females -->
  <option value="2nd Shear Ewes">
  <option value="Full Wool Ewes">
  <option value="Merino Ewes">
  <option value="Half Bred Ewes">
  <option value="1/4 Bred Ewes">
  <option value="Corridale Ewes">
  <option value="Ewes">

  <!-- Lambs ‚Äì Female -->
  <option value="Ewe Lambs">
  <option value="Merino Ewe Lambs">

  <!-- Lambs ‚Äì Male -->
  <option value="Ram Lambs">
  <option value="Merino Ram Lambs">

  <!-- Lambs ‚Äì Wether or Mixed -->
  <option value="Wether Lambs">
  <option value="Mixed Lambs">
  <option value="Long Tails">

  <!-- Adult Males -->
  <option value="Rams">
  <option value="Stud Rams">
  <option value="Merino Rams">
  <option value="Merino Stud Rams">
  <option value="Wethers">
  <option value="Merino Wethers">

  <!-- Unknown / Crutching -->
  <option value="Uncrutched">
  <option value="Fly Blow">
  <option value="Full Belly Crutching">
  <option value="Ring Crutching">
</datalist>

<script src="xlsx.full.min.js"></script>
<script type="module" src="auth.js"></script>
<script src="/tally.js"></script>
<script src="export.js"></script>

  </div> <!-- tallySheetView -->

<div id="summaryView" class="view" style="display:none;">
  <div class="logo-container">
      <img src="logo.png" alt="SHEŒîR iQ logo" />
      <h2>Tally Processor</h2>
  </div>
  <h3 id="summaryTitle" style="margin-top: 10px;"></h3>
  <table id="summaryTable">
    <thead>
      <tr></tr>
    </thead>
    <tbody id="summaryTableBody"></tbody>
  </table>
  <div class="section">
    <h2>Shed Staff</h2>
    <table>
      <thead>
        <tr><th>Name</th><th>Hours Worked</th></tr>
      </thead>
      <tbody id="summaryShedStaff"></tbody>
    </table>
  </div>
</div>

<div id="stationSummaryView" class="view" style="display:none;">
  <div class="logo-container">
      <img src="logo.png" alt="SHEŒîR iQ logo" />
      <h2>Farm Summary</h2>
  </div>
  <div class="filters">
    <label for="stationSelect">Farm:</label>
     <select id="stationSelect" class="small-input"></select>
    <label for="summaryStart">Start Date:</label>
    <input id="summaryStart" type="date" />
    <label for="summaryEnd">End Date:</label>
    <input id="summaryEnd" type="date" />
    <button id="stationSummaryApply">Apply</button>
  </div>
   <p id="stationNoData" class="message" style="display:none;">No data found for the selected station and dates.</p>
  <h3>Shearer Summary</h3>
  <table id="stationShearerTable">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Shed Staff</h3>
  <table id="stationStaffTable">
    <thead><tr><th>Name</th><th>Hours Worked</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Team Leaders</h3>
  <table id="stationLeaderTable">
    <thead><tr><th>Name</th><th>Total Sheep</th><th>Dates Led</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Comb Types</h3>
  <table id="stationCombTable">
    <thead><tr><th>Comb Type</th><th>Dates Used</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Totals</h3>
  <table id="stationTotalTable">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>
  <button id="exportFarmSummaryBtn" class="main-button" data-help="Export the farm summary (contractor only).">Export Farm Summary</button>
</div>
 
<footer id="footer">Logged in as: <span id="userEmail">loading...</span></footer>

<!-- Setup Modal -->
<div id="setupModal" class="modal-overlay">
  <div class="modal-box">
    <h3>Setup Day</h3>
    <div class="form-row">
      <label for="setupShearers"># Shearers</label>
      <small class="field-hint">Number of shearers today (Adds columns to the shearer table).</small>
      <select id="setupShearers"></select>
    </div>

    <div class="form-row">
      <label for="setupRuns"># Tally Rows</label>
      <small class="field-hint">How many runs or cut outs today? (Adds rows to the shearer table)</small>
      <select id="setupRuns"></select>
    </div>

    <div class="form-row">
      <label for="setupStaff"># Shed Staff</label>
      <small class="field-hint">Number of shed staff today? (Adds rows to the shed staff table)</small>
      <select id="setupStaff"></select>
    </div>

    <div class="form-row">
      <label for="lunchLength">Lunch Break Length</label>
      <small class="field-hint">How long is lunch break. 45 minutes or 1 hour</small>
      <select id="lunchLength">
        <option value="60">60 minutes</option>
        <option value="45">45 minutes</option>
      </select>
    </div>

    <div class="form-row" style="margin-top:12px">
      <label>
        <input type="checkbox" id="disableSetupModalFromSetup">
        Don‚Äôt show this Setup Day popup automatically
      </label>
      <small class="field-hint">You can turn this back on anytime from the Help menu.</small>
    </div>

    <div class="modal-buttons" style="margin-top:20px;">
      <button id="setupConfirmBtn">Confirm</button>
      <button id="setupCancelBtn">Cancel</button>
    </div>
  </div>
</div>
<script>
firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    document.getElementById("userEmail").textContent = user.email;
  } else {
    document.getElementById("userEmail").textContent = "Not logged in";
  }
});

document.addEventListener('DOMContentLoaded', function () {
  ['setupShearers', 'setupRuns', 'setupStaff'].forEach(function(id) {
    var select = document.getElementById(id);
    if (!select) return;
    var opts = '<option value=""></option>';
    for (var i = 1; i <= 100; i++) {
      opts += '<option value="' + i + '">' + i + '</option>';
    }
    select.innerHTML = opts;
  });
});
</script>
<!-- Reset Confirmation Modal -->
<div id="resetModal" class="modal-overlay">
  <div class="modal-box">
    <h3>New Day Reset</h3>
    <p>What type of reset do you want to perform?</p>
    <div class="modal-buttons">
      <button id="partialResetBtn">üîÅ Partial Reset</button>
      <button id="fullResetBtn">üóë Full Reset</button>
      <button id="cancelResetBtn">‚ùå Cancel</button>
    </div>
  </div>
</div>

<!-- Load Session Modal -->
<div id="loadSessionModal" class="modal-overlay">
  <div class="modal-box">
    <div id="loadSessionStep1">
      <h3>Load Session</h3>
      <p>Select a session to load:</p>
      <div class="modal-buttons">
        <button id="loadLastBtn">Last Session</button>
        <button id="loadOtherBtn">Other Session</button>
        <button id="cancelLoadBtn">‚ùå Cancel</button>
      </div>
    </div>
    <div id="loadSessionStep2" style="display:none;">
      <label for="loadStationInput">Station:</label><br/>
      <input list="loadStationList" id="loadStationInput" class="small-input"/><br/><br/>
      <label for="loadDateInput">Date (DD/MM/YYYY):</label><br/>
      <input list="loadDateList" id="loadDateInput" class="small-input"/><br/>
      <datalist id="loadStationList"></datalist>
      <datalist id="loadDateList"></datalist>
      <div class="modal-buttons" style="margin-top:10px;">
        <button id="confirmLoadBtn">Load</button>
        <button id="loadSessionBackBtn">Back</button>
      </div>
    </div>
  </div>
</div>
<!-- Unsaved Changes Modal -->
  <div id="unsavedModal" class="modal-overlay">
    <div class="modal-box">
      <p>You have unsaved work. What would you like to do?</p>
      <div class="modal-buttons">
        <button id="unsavedSaveBtn">Save & Continue</button>
        <button id="unsavedDiscardBtn">Continue Without Saving</button>
        <button id="unsavedCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var modal = document.getElementById('resetModal');
  var openBtn = document.getElementById('newDayResetBtn');
  var partialBtn = document.getElementById('partialResetBtn');
  var fullBtn = document.getElementById('fullResetBtn');
  var cancelBtn = document.getElementById('cancelResetBtn');

  function showModal() {
    if (modal) modal.style.display = 'flex';
  }
  function hideModal() {
    if (modal) modal.style.display = 'none';
  }

  function clearCommonFields() {
    document.querySelectorAll('#tallyBody input').forEach(function (el) { el.value = ''; });
    document.querySelectorAll('#tallyBody select').forEach(function (el) { el.value = ''; });
    ['date','startTime','finishTime','hoursWorked'].forEach(function(id){
      var e = document.getElementById(id);
      if (e) e.value = '';
    });
    var totalsBody = document.querySelector('#sheepTypeTotalsTable tbody');
    if (totalsBody) totalsBody.innerHTML = '';
    document.querySelectorAll('#shedStaffTable tr td:nth-child(2) input').forEach(function(el){ el.value = ''; });
  }

  function performReset(full) {
  clearCommonFields();
  // Always clear cached session metadata so a new day doesn't reuse the old ID
  if (window.resetForNewDay) window.resetForNewDay();

  if (full) {
    // Clear input fields
    ['stationName','teamLeader','combType'].forEach(function(id){
      const e = document.getElementById(id);
      if (e) e.value = '';
    });

    if (window.resetTallySheet) window.resetTallySheet(); 
    window.awaitingSetupPrompt = true;
  }

  const table = document.getElementById('tallyTable');
  if (table) table.dispatchEvent(new Event('input', { bubbles: true }));
  hideModal();
  if (window.unlockSession) window.unlockSession();
}

  window.performReset = performReset;
 
  if (openBtn) openBtn.addEventListener('click', showModal);
  if (partialBtn) partialBtn.addEventListener('click', function(){ performReset(false); });
  if (fullBtn) fullBtn.addEventListener('click', function(){ performReset(true); });
  if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
});
</script>

<!-- Load Options Modal -->
<div id="loadOptionsModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Where do you want to load from?</h3>
    <div class="modal-buttons">
      <button id="loadLocalBtn">üìÅ Load from Device</button>
      <button id="loadCloudBtn">‚òÅÔ∏è Load from Cloud</button>
    </div>
  </div>
</div>

<!-- Save Options Modal -->
<div id="saveOptionsModal" class="modal-overlay">
  <div class="modal-box">
    <h3>Save Session</h3>
    <div class="modal-buttons">
      <button id="saveLocalBtn">üìÅ Save to Device</button>
      <button id="saveCloudBtn">‚òÅÔ∏è Save to Cloud</button>
      <button id="saveBothBtn">üîÑ Save to Both</button>
    </div>
  </div>
</div>

<!-- Cloud Session Modal -->
<div id="cloudSessionModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h3>Select Cloud Session</h3>
    <select id="cloudSessionSelect" class="small-input" style="width:100%; margin-bottom:10px;"></select>
    <div class="modal-buttons">
      <button id="loadCloudConfirmBtn">Load Selected Session</button>
      <button id="cancelCloudLoadBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
window.clearStationSummaryView = clearStationSummaryView;

document.addEventListener('DOMContentLoaded', () => {
    const applyBtn = document.getElementById('stationSummaryApply');
    if (applyBtn) {
      applyBtn.addEventListener('click', () => {
         alert('‚úÖ Farm Summary complete.');
        buildStationSummary();
      });
    }
  });
</script>

<div id="autosaveStatus" style="display:none; position:fixed; bottom:10px; right:10px; background:#222; color:#fff; padding:4px 8px; border-radius:4px; font-size:14px;"></div>
<div id="hours-modal" class="hours-modal" aria-hidden="true">
  <div class="hours-modal-content">
    <p>Hours Worked automatically fills from Start and Finish times.</p>
    <div class="hours-modal-actions">
      <button type="button" id="hours-modal-ok">OK</button>
      <button type="button" id="hours-modal-manual">Enable manual entry</button>
    </div>
  </div>
</div>
<div id="autosaveInfo" style="display:none; position:fixed; bottom:10px; left:10px; color:#888; font-size:12px;"></div>
<div id="loading-overlay">
  <div class="circle-spinner"></div>
  <div>Authenticating‚Ä¶ Please wait</div>
</div>

<button id="help-btn" aria-label="Help">?</button>
<div id="tt-help-menu" class="tt-hidden" aria-hidden="true"></div>
<div id="tt-root" class="tt-hidden" role="tooltip" aria-hidden="true" aria-live="polite"></div>



<style>
    #tt-root {
      position: fixed;
      max-width: 280px;
      padding: 10px 12px;
      background: rgba(20,20,20,0.95);
      color: #fff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      z-index: 900;
      font-size: 14px;
      line-height: 1.35;
      pointer-events: none;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 120ms ease, transform 120ms ease;
    }
    #tt-root.guided {
      pointer-events: auto;
    }
    #tt-root .tt-guided-controls {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    .tt-highlight {
      outline: 3px solid rgba(255,255,255,0.5);
      outline-offset: 3px;
      border-radius: 8px;
    }
    .tt-show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    .tt-hidden {
      display: none;
      opacity: 0;
    }
    @media (prefers-reduced-motion: reduce) {
      #tt-root { transition: none; }
    }
    #tt-disabled-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20,20,20,0.95);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 9999;
      display: none;
    }
  </style>

<style id="tt-help-menu-base">
  #tt-help-menu{
    position:fixed;
    z-index:2147483646;
    display:none;
    background:rgba(20,20,20,0.97);
    color:#fff;
    padding:12px;
    border-radius:10px;
    min-width:240px;
    max-width:calc(100vw - 16px);
    max-height:80vh;
    overflow:auto;
    box-shadow:0 10px 30px rgba(0,0,0,.45);
  }
  #tt-help-menu .row{display:flex;gap:8px;margin-top:10px}
  #tt-help-menu button,#tt-help-menu label{font-size:14px;line-height:1.2}
</style>

<!-- Tally Onboarding Modal (Merged) -->
<div id="tally-onboard-overlay" role="dialog" aria-modal="true" aria-labelledby="tally-onboard-title" aria-hidden="true">
  <div id="tally-onboard-dialog">
    <h2 id="tally-onboard-title">Welcome to the SHEŒîR iQ Tally Tour</h2>
    <p>This quick tour will show you the key parts of the tally page and how to use them. You can skip it anytime ‚Äî you‚Äôll still be able to hover or long-press fields for tips later.</p>
    <p>You can also enable or disable tooltips and the guided tour. These settings can be changed anytime from the Help menu (the ‚Äú?‚Äù button).</p>

    <form id="tally-onboard-form">
      <label><input type="checkbox" id="onboard-tooltips"> Enable tooltips</label>
      <label><input type="checkbox" id="onboard-tour"> Enable guided tour</label>
      <div class="form-row" style="margin-top:12px">
        <label>
          <input type="checkbox" id="disableSetupModalChk">
          Don‚Äôt show the Setup Day popup automatically
        </label>
        <small class="field-hint">You can turn this back on anytime from the Help menu.</small>
      </div>
    </form>

    <div id="tally-onboard-actions">
      <button type="button" id="onboard-save-start" class="tw-btn tw-btn-primary">Save &amp; Start Tour</button>
      <button type="button" id="onboard-save" class="tw-btn tw-btn-ghost">Save Only</button>
      <button type="button" id="onboard-help" class="tw-btn tw-btn-ghost">Open Help Menu</button>
      <button type="button" id="onboard-skip" class="tw-btn tw-btn-ghost">Skip for now</button>
    </div>
  </div>
  <span aria-hidden="true"></span>
</div>
<script>
(function(){
  const overlay = document.getElementById('tally-onboard-overlay');
  const tips = document.getElementById('onboard-tooltips');
  const tour = document.getElementById('onboard-tour');
  const disableSetup = document.getElementById('disableSetupModalChk');
  const saveStart = document.getElementById('onboard-save-start');
  const saveOnly = document.getElementById('onboard-save');
  const openHelp = document.getElementById('onboard-help');
  const skip = document.getElementById('onboard-skip');

  const gb = k => (localStorage.getItem(k) ?? 'true') === 'true';
  const sb = (k,v) => localStorage.setItem(k, v ? 'true' : 'false');

  function openModal(){
    if (localStorage.getItem('tally_onboard_seen') === 'true') return;
    tips.checked = gb('tooltips_enabled');
    tour.checked = gb('tally_guide_enabled');
    if (disableSetup) disableSetup.checked = (isSetupModalEnabled() === false);
    overlay.classList.add('show');
    overlay.removeAttribute('aria-hidden');
    document.body.style.overflow = 'hidden';
    const first = overlay.querySelector('input,button');
    if (first) first.focus();
  }

  function closeModal(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  function saveChoices(){
    // persist to storage
    localStorage.setItem('tooltips_enabled', tips.checked ? 'true' : 'false');
    localStorage.setItem('tally_guide_enabled', tour.checked ? 'true' : 'false');

    // NEW: update runtime flags immediately (safe if functions don‚Äôt exist)
    try { if (typeof window.setTipsEnabled  === 'function') window.setTipsEnabled(!!tips.checked); } catch(e){}
    try { if (typeof window.setGuideEnabled === 'function') window.setGuideEnabled(!!tour.checked); } catch(e){}

    if (disableSetup) setSetupModalEnabled(!disableSetup.checked);

    // mark onboarding as seen
    localStorage.setItem('tally_onboard_seen','true');
  }

  saveStart.addEventListener('click', () => {
    saveChoices();
    closeModal();
    if (tour.checked && typeof window.startGuide === 'function') window.startGuide();
  });
  saveOnly.addEventListener('click', () => { saveChoices(); closeModal(); });
  openHelp.addEventListener('click', () => { saveChoices(); closeModal(); if (typeof window.openHelpMenu === 'function') window.openHelpMenu(); });
  skip.addEventListener('click', () => {
    if (disableSetup) setSetupModalEnabled(!disableSetup.checked);
    localStorage.setItem('tally_onboard_seen','true');
    closeModal();
  });

  overlay.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { e.preventDefault(); skip.click(); }
    if (e.key === 'Tab') {
      const focusables = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (focusables.length === 0) return;
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
  });

  document.addEventListener('DOMContentLoaded', openModal);
})();
</script>
<div id="sync-status-banner"></div>
  <script src="/pwa-suppress-install.js" defer></script>
  <script src="app-launch-guard.js" defer></script>
  <script>
    try {
      if (!localStorage.getItem('user_role')) {
        localStorage.setItem('user_role', 'staff');
      }
      localStorage.setItem('preferred_start', 'tally');
    } catch(e) {}
  </script>
</body>
</html>
